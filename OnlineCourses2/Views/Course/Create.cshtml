@model OnlineCourses2.ViewModels.CreateCourseViewModel

@{
    ViewData["Title"] = "Създай курс";
}

<main style="max-width: 750px; margin: 40px auto; padding: 0 20px;">

    <h2 style="margin-bottom: 25px; text-align:left;">Създаване на нов курс</h2>

    <form method="post" enctype="multipart/form-data"
          style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">

        <div style="margin-bottom: 15px;">
            <label>Снимка на курса</label>
            <input asp-for="ImageFile" type="file"
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;" />
        </div>

        <!-- Title -->
        <div style="margin-bottom: 15px;">
            <label>Заглавие</label>
            <input id="title" asp-for="Title"
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;" />
            <small style="color:#777;">Въведете кратко и ясно заглавие</small>
            <div class="error" id="title-error"></div>
        </div>


        <!-- Short Description -->
        <div style="margin-bottom: 15px;">
            <label>Кратко описание</label>
            <input id="shortDesc" asp-for="ShortDescription"
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;" />
            <small style="color:#777;">1–2 изречения, които описват курса</small>

            <div class="error" id="shortDesc-error"></div>
        </div>


        <!-- Description -->
        <div style="margin-bottom: 15px;">
            <label>Описание</label>
            <textarea id="description" asp-for="Description" rows="4"
                      style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
            <small style="color:#777;">Подробна информация за курса</small>
            <div class="error" id="description-error"></div>
        </div>


        <!-- Duration -->
        <div style="margin-bottom: 15px;">
            <label>Продължителност (часове)</label>
            <input id="duration" asp-for="DurationHours" type="number"
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;" />
            <small style="color:#777;">Минимум 8, максимум 30 часа</small>
            <div class="error" id="duration-error"></div>
        </div>


        <!-- Price -->
        <div style="margin-bottom: 15px;">
            <label>Цена</label>
            <input id="price" asp-for="Price" type="number" step="0.01"
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;" />
            <small style="color:#777;">Цената трябва да е по-голяма от 0</small>
            <div class="error" id="price-error"></div>
        </div>


        <!-- Max Participants -->
        <div style="margin-bottom: 15px;">
            <label>Максимален брой участници</label>
            <input id="maxParticipants" asp-for="MaxParticipants" type="number"
                   style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;" />
            <small style="color:#777;">Минимум 10, максимум 20 участници</small>
            <div class="error" id="participants-error"></div>
        </div>
        <div class="form-group">
            <label asp-for="StartDate"></label>
            <input asp-for="StartDate" type="date" class="form-control" />
            <span asp-validation-for="StartDate" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="EndDate"></label>
            <input asp-for="EndDate" type="date" class="form-control" />
            <span asp-validation-for="EndDate" class="text-danger"></span>
        </div>



        <!-- Certificate -->
        <div style="margin-bottom: 20px;">
            <label>Сертификат</label>
            <select asp-for="HasCertificate"
                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                <option value="true">Със сертификат</option>
                <option value="false">Без сертификат</option>
            </select>
        </div>

        <!-- Category -->
        <div style="margin-bottom: 20px;">
            <label>Категория</label>
            <select asp-for="CategoryId"
                    style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                <option value="">-- Изберете категория --</option>
                @foreach (var cat in Model.Categories)
                {
                    <option value="@cat.Id">@cat.Name</option>
                }
            </select>
            <span asp-validation-for="CategoryId" style="color:red;"></span>
        </div>

        <!-- Buttons -->
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <a asp-action="Manage" asp-controller="Course"
               style="text-decoration:none; color:#555;">
                ← Назад
            </a>

            <button id="create-btn" type="submit"
                    style="background-color:#81d8b0; color:white; border:none;
               padding:10px 25px; border-radius:6px; font-weight:500; cursor:pointer;">
                Създай курс
            </button>
            

        </div>

    </form>
    <div id="toast"
         style="
        visibility:hidden;
        min-width:250px;
        background:#333;
        color:#fff;
        text-align:center;
        border-radius:6px;
        padding:15px;
        position:fixed;
        top:20px;
        right:20px;
        z-index:9999;
        opacity:0;
        transition:opacity 0.5s, visibility 0.5s;
     ">
    </div>
</main>
@if (TempData["Success"] != null)
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            showToast("@TempData["Success"]", "#27ae60");
        });
    </script>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const duration = document.querySelector("input[name='DurationHours']");
            const price = document.querySelector("input[name='Price']");
            const maxParticipants = document.querySelector("input[name='MaxParticipants']");
            const title = document.querySelector("input[name='Title']");
            const shortDesc = document.querySelector("input[name='ShortDescription']");
            const desc = document.querySelector("textarea[name='Description']");
            const form = document.querySelector("form");

            // 1) Премахване на 0 при фокус
            [duration, price, maxParticipants].forEach(field => {
                field.addEventListener("focus", () => {
                    if (field.value === "0") field.value = "";
                });
            });

            // 2) Забрана за отрицателни стойности
            [duration, price, maxParticipants].forEach(field => {
                field.addEventListener("input", () => {
                    if (field.value < 0) field.value = 0;
                });
            });

            // 3) Валидации при изпращане
            form.addEventListener("submit", function (e) {

                let errors = [];

                // Задължителни полета
                if (title.value.trim() === "") errors.push("Заглавието е задължително.");
                if (shortDesc.value.trim() === "") errors.push("Краткото описание е задължително.");
                if (desc.value.trim() === "") errors.push("Описанието е задължително.");

                // Продължителност
                if (duration.value < 8 || duration.value > 30)
                    errors.push("Продължителността трябва да е между 8 и 30 часа.");

                // Цена
                if (price.value <= 0)
                    errors.push("Цената трябва да е по-голяма от 0.");

                // Участници
                if (maxParticipants.value < 10 || maxParticipants.value > 20)
                    errors.push("Броят участници трябва да е между 10 и 20.");

                if (errors.length > 0) {
                    e.preventDefault();
                    alert(errors.join("\n"));
                }
            });

        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Взимаме всички полета
            const title = document.querySelector("input[name='Title']");
            const shortDesc = document.querySelector("input[name='ShortDescription']");
            const desc = document.querySelector("textarea[name='Description']");
            const duration = document.querySelector("input[name='DurationHours']");
            const price = document.querySelector("input[name='Price']");
            const maxParticipants = document.querySelector("input[name='MaxParticipants']");
            const category = document.querySelector("select[name='CategoryId']");
            const form = document.querySelector("form");
            const submitBtn = document.querySelector("button[type='submit']");

            // Създаваме обект с грешки
            const errors = {
                title: "",
                shortDesc: "",
                desc: "",
                duration: "",
                price: "",
                maxParticipants: "",
                category: ""
            };

            // Показване на грешки под полетата
            function showError(fieldName, message) {
                errors[fieldName] = message;
                let span = document.querySelector(`span[data-error='${fieldName}']`);

                if (!span) {
                    span = document.createElement("span");
                    span.style.color = "red";
                    span.setAttribute("data-error", fieldName);
                    const inputField = document.querySelector(`[name='${fieldName}']`);
                    inputField.insertAdjacentElement("afterend", span);
                }

                span.textContent = message;
                validateForm();
            }

            // Изчистване на грешка
            function clearError(fieldName) {
                errors[fieldName] = "";
                const span = document.querySelector(`span[data-error='${fieldName}']`);
                if (span) span.textContent = "";
                validateForm();
            }

            // Disable/Enable на бутона
            function validateForm() {
                const hasErrors = Object.values(errors).some(e => e !== "");
                submitBtn.disabled = hasErrors;
                submitBtn.style.opacity = hasErrors ? "0.5" : "1";
                submitBtn.style.cursor = hasErrors ? "not-allowed" : "pointer";
            }

            // Премахване на 0 при фокус
            [duration, price, maxParticipants].forEach(field => {
                field.addEventListener("focus", () => {
                    if (field.value === "0") field.value = "";
                });
            });

            // Забрана за отрицателни стойности
            [duration, price, maxParticipants].forEach(field => {
                field.addEventListener("input", () => {
                    if (field.value < 0) field.value = 0;
                });
            });

            // LIVE ВАЛИДАЦИЯ
            title.addEventListener("input", () => {
                if (title.value.trim() === "") showError("Title", "Заглавието е задължително.");
                else clearError("Title");
            });

            shortDesc.addEventListener("input", () => {
                if (shortDesc.value.trim() === "") showError("ShortDescription", "Краткото описание е задължително.");
                else clearError("ShortDescription");
            });

            desc.addEventListener("input", () => {
                if (desc.value.trim() === "") showError("Description", "Описанието е задължително.");
                else clearError("Description");
            });

            duration.addEventListener("input", () => {
                if (duration.value < 8 || duration.value > 30)
                    showError("DurationHours", "Продължителността трябва да е между 8 и 30 часа.");
                else clearError("DurationHours");
            });

            price.addEventListener("input", () => {
                if (price.value <= 0)
                    showError("Price", "Цената трябва да е по-голяма от 0.");
                else clearError("Price");
            });

            maxParticipants.addEventListener("input", () => {
                if (maxParticipants.value < 10 || maxParticipants.value > 20)
                    showError("MaxParticipants", "Броят участници трябва да е между 10 и 20.");
                else clearError("MaxParticipants");
            });

            category.addEventListener("change", () => {
                if (category.value === "")
                    showError("CategoryId", "Моля изберете категория.");
                else clearError("CategoryId");
            });

            // Финална проверка при submit
            form.addEventListener("submit", function (e) {
                validateForm();
                const hasErrors = Object.values(errors).some(e => e !== "");
                if (hasErrors) e.preventDefault();
            });

            validateForm();
        });
                function showToast(message, color = "#333") {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.style.background = color;
            toast.style.visibility = "visible";
            toast.style.opacity = "1";

            setTimeout(() => {
                toast.style.opacity = "0";
                toast.style.visibility = "hidden";
            }, 3000);
        }

    </script>
}

